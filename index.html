<!DOCTYPE html>
<html>


<head>
  <title>Hospital Closures In The U.S. | Alex Klavens </title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Rural Hospital Closures in the U.S." />


  <link rel="stylesheet" type="text/css" href="style.css" />

  <link rel="stylesheet" type="text/css" href="map-style.css" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@alexklavens">
  <meta name="twitter:creator" content="@alexklavens">
  <meta name="twitter:title" content="Rural Hospital Closures in the U.S.">
  <meta name="twitter:description" content="Working Project Visualizing Hospital Closures in the U.S.">
  <meta name="twitter:image" content="preview.png">

</head>
<meta charset="utf-8">

<body>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>

<style>
  #showInfoBox-button {
    border: 1px solid black;
    border-radius: 3px;
    background: rgb(200, 200, 200);
    font-size: 1.3em;

    margin-bottom: 10px;
  }
  #info-box {
    visibility: visible;
  }



</style>

<body>
  <h1>U.S. Hospital Closures Since 2005</h1>
  <button id="showInfoBox-button">Show Details</button>
  <div id="info-box">
    <table>
      <tr>
        <th>Hospital</th>
        <td width ="450px" id="hos-name"> hospital_name </td>
      </tr>
      <tr>
        <th>Closure Year</th>
        <td id="closure-date"> closure_date </td>
      </tr>
      <tr>
        <th>Number of Beds</th>
        <td id="closure-date"> closure_date </td>
      </tr>
      <tr>
        <th>Locaiton</th>
        <td width="200px" id="city-state"> city, state</td>
      </tr>
      <tr>
        <th>Coordinates</th>
        <td width="200px" id="city-state"> city, state</td>
      </tr>


    </table>
  </div>
</body>

<script>
  function showInfoBox(){
    var show = "Show Details",
        hide = "Hide Details";
    var thisText = document.getElementById("showInfoBox-button").innerHTML;
    if (thisText == hide){
      document.getElementById("info-box").style.visibility = "collapse";
      document.getElementById("showInfoBox-button").innerHTML = show;
    } else if (thisText == show) {
      document.getElementById("info-box").style.visibility = "visible";
      document.getElementById("showInfoBox-button").innerHTML = hide;
    }
    // else{
    //   document.getElementById("info-box").style.visibility = "visible";
    //   document.getElementById("showInfoBox-button").innerHTML = "Hide Info Box";
    // }
  }
</script>

<style>
  #tooltip {
    color: white;
    font-size: 1em;
    padding: 5px;
    background-color: rgb(110, 110, 110);
    border-radius: 5px;
    max-width: 200px;
    opacity: .9;
    font-family: Futura;
  }
</style>

<script>
var mult = 1;
var width = 1080 * mult,
    height = 600 * mult,
    trans = 750,
    zoomedIn = false,
    centered;

var radius = d3.scale.sqrt()
    .domain([0, 25])
    .range([2, 10]);

// width= width * 1.4;
var projection = d3.geo.albersUsa()
  // .scale(1070)
  .scale(width)
  .translate([width / 2, height / 2]);

var path = d3.geo.path()
  .projection(projection);


var tooltip = d3.select("body")
	.append("div")
  .attr("id","tooltip")
	.style("position", "absolute")
	.style("z-index", "10")
	.style("visibility", "hidden")
  .style("border-radius","2px")
  .text("");

var svg = d3.select("body").append("svg")
    .attr("width", "100%")
    .attr("height", "100%");

    svg.append("rect")
      .attr("class","background")
      .attr("width", "100%")
      .attr("height", "100%")
      .on("click", activate_hospital);

var g = svg.append("g");

queue()
    .defer(d3.json, "us.json")
    .defer(d3.json, "hospitals.json")
    .await(ready);

function ready(error, us, hospital) {
  if (error) throw error;
  var active_hospital;
  main_geo_unit = us.objects.states;

  g.append("g")
    .attr("id", "states")
    .selectAll("path")
    .data(topojson.feature(us, main_geo_unit).features)
    .enter().append("path")
    .attr("d", path);

  g.append("path")
    .datum(topojson.mesh(us, main_geo_unit, function (a, b){return a !== b;}))
    .attr("id", "borders")
    .attr("d", path(topojson.mesh(us, main_geo_unit, function(a, b) { return a = b; })));

  g.append("path")
    .datum(topojson.mesh(us, us.objects.counties, function (a,b) {return a !== b;}))
    .attr("id", "county-borders")
    .attr("d", path(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b; })));

  function zoomIn_counties(){
      d3.select('#county-borders')
      .attr("d", path(topojson.mesh(us, us.objects.counties, function(a, b) { return a == b; })));
    }

  var anyActive;
  g.append("g")
    .attr("id","symbol")
    .selectAll("path")
    .data(hospital.features.sort(function(a, b) { return parseInt(b.properties.Number_of_Beds) - parseInt(a.properties.Number_of_Beds); }))
    .enter().append("path")
    .attr("d",path.pointRadius(function (d) {return radius(d.properties["Number_of_Beds"])}))
      .on("click",function(d){
        active_hospital = d;
        anyActive = activate_hospital(d);
        fillInfoBox(d);
        if (anyActive == false) { //zoom out
           zoomedIn = false; adjustRadius(1, 2000);
           d3.selectAll("g").style("stroke-width",".2px");
         }
        else { //zoom in
          d3.selectAll("g").style("stroke-width",".1px");
          zoomedIn = true; adjustRadius(.2, trans);
          zoomIn_counties();
        }})

      .on("mouseover",function(d){
        var setText = getToolTipInfo(d);
        tooltip.style("visibility", "visible")
        .style("top", (event.pageY-20)+"px")
                .style("left",(event.pageX+20)+"px")
                .text(setText);
        if (zoomedIn == false) {
          fillInfoBox(d);
        } else if (zoomedIn && d == active_hospital) {
          console.log(d);
        }
        d3.select(this).style("stroke","#000");
        })

      .on("mouseout",function(){
        tooltip.style("visibility", "hidden");
        d3.select(this).style("stroke","#FFF");
          });
}

function adjustRadius(adjust_fraction, durr = trans){
  var working = g.select("#symbol").selectAll("path")
    .transition()
      .duration(durr)
      .attr("d",path.pointRadius(function(d){return radius(d.properties.Number_of_Beds)*adjust_fraction}));
  }


function getToolTipInfo(d){
  var hospital = d.properties.Hospital,
      beds = d.properties.Number_of_Beds;
  return hospital+"'s closure resulted in the loss of " + beds+ " beds";
  // return '<tspan>'+hospital+'</tspan>' + "'s closure resulted in the loss of " + '<tspan>'+beds+'</tspan>' + " beds";

}

function fillInfoBox(d){
  document.getElementById('hos-name').innerHTML = d.properties.Hospital;
  document.getElementById('closure-date').innerHTML = d.properties["Closure_Year"]
  document.getElementById('num-beds').innerHTML = d.properties["Number_of_Beds"];
  document.getElementById('coords').innerHTML = d.geometry.coordinates;
  document.getElementById('city-state').innerHTML = d.properties["City"] + ", " + d.properties["State"];
}

function activate_hospital(d) {
  var x, y, k, zoomedIn;
  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 15;
    centered = d;
    zoomedIn = true;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
    zoomedIn = false;
  }

  g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(trans)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");
  return zoomedIn;
}

</script>
</html>
